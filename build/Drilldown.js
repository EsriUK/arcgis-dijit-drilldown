define(["dojo/_base/declare","dijit/_Widget","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","esri/dijit/Search","dojo/dom-construct","dijit/layout/ContentPane","dijit/TitlePane","dojox/widget/TitleGroup","dojo/on","dojo/Deferred","dojo/query","dojo/store/Memory","dojo/NodeList-data"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=function(a){return void 0===a||null===a||""===a},o=function(a,b){var c,d=0,e=0,j=new i,k=a.Addresses;for(j.startup(),d=0,e=k.length;e>d;d+=1)c=f.toDom("<span class='drilldownResult'>"+k[d].address+"</span>"),l(c).data("result",k[d]),j.addChild(new g({content:c}));b.addChild(new h({title:a.Description,content:j,open:!1}))};return a([b,c,d,e],{baseClass:"drilldown",widgetsInTemplate:!0,resultsElement:null,_titleGroups:[],_resultsStore:null,constructor:function(b){a.safeMixin(this,b)},destroy:function(){this._clearPicklist(),this.inherited(arguments)},search:function(){var a=this,b=new k;return this.inherited(arguments).then(function(c){a._buildPickListUi(c),b.resolve()}),b.promise},clear:function(){this._clearPicklist(),this.inherited(arguments)},_hydrateResults:function(a){return a.PickListItems?a:this.inherited(arguments)},_formatResults:function(a,b,c){var d={activeSourceIndex:b,value:c,numResults:0,numErrors:0,errors:null,results:null},e={},f={},g=0;if(a){if(b===this._allIndex){for(g=0;g<a.length;g++)n(this.sources[g].locator.locatorType)?d=this.inherited(arguments):(f[b]=a[0],d.numResults+=a[0].PickListItems.length);return d.results=f,d.err=e,d}return n(this.activeSource.locator.locatorType)?this.inherited(arguments):(f[b]=a[0],d.numResults+=a[0].PickListItems.length,d.results=f,d.err=e,d)}return d},_clearPicklist:function(){var a,b;if(this._titleGroups.length>0){for(a=0,b=this._titleGroups.length;b>a;a++)this._titleGroups[a].destroy();this._titleGroups=[]}},_showNoResults:function(){this._noResults(this.value),this._showNoResultsMenu()},_isSingleResult:function(a){var b,c,d,e=0;for(d in a)a.hasOwnProperty(d)&&(e++,c=d);if(1===e){if(b=a[c].PickListItems,1===b.length&&1===b[0].Addresses.length){if(n(b[0].Addresses[0].Addresses))return!0;if(!n(b[0].Addresses[0].Addresses)&&1===b[0].Addresses[0].Addresses.length)return!0}return!1}return!1},_buildPickListUi:function(a){var b,c,d,e,g,m,o,p,q=this,r=0,s=0,t=!1,u=this._createGroup,v=new k;if(this._clearPicklist(),f.destroy(this.resultsElement),this.resultsElement=f.create("div",{"class":"arcgisSearch searchGroup picklistResults"},this.domNode,"last"),q.activeSourceIndex!==this._allIndex&&this._isSingleResult(a))m=this._hydrateResult(a[0].PickListItems[0].Addresses[0],q.activeSourceIndex,!1),this.select(m);else{if(!n(a)){for(g in a)if(a.hasOwnProperty(g))if(n(a[g])||n(a[g].PickListItems))t=!0;else if(b=a[g].PickListItems,s=b.length,s>0)for(o=f.create("div",{id:g},this.resultsElement,"last"),c=new i(null,o),this._titleGroups.push(c),r=0;s>r;r+=1)d=[],e=u(b[r]),p=new h({title:b[r].Description,content:e,open:1===s?!0:!1}),p.startup(),c.startup(),c.addChild(p),t=!1;else t=!0;v.resolve()}t&&this._showNoResults(),n(this.resultsElement)||j(this.resultsElement,".drilldownResult:click",function(){var a=l(this).data()[0],b=q._hydrateResult(a.result,q.activeSourceIndex,!1);q.select(b)})}return v.promise},_createGroup:function(a){var b,c,d=0,e=0,h=new i;if(!n(a.Addresses)&&a.Addresses.length>1){for(b=a.Addresses,d=0,e=b.length;e>d;d++)!n(b[d].Addresses)&&b[d].Addresses.length>1?o(b[d],h):(n(b[d].address)?(c=f.toDom("<span class='drilldownResult'>"+b[d].Addresses[0].address+"</span>"),l(c).data("result",b[d].Addresses[0])):(c=f.toDom("<span class='drilldownResult'>"+b[d].address+"</span>"),l(c).data("result",b[d])),h.addChild(new g({content:c})));h.startup()}else n(a.Addresses[0].address)?!n(a.Addresses[0].Addresses)&&a.Addresses[0].Addresses.length>0&&(o(a.Addresses[0],h),h.startup()):(c=f.toDom("<span class='drilldownResult'>"+a.Addresses[0].address+"</span>"),l(c).data("result",a.Addresses[0]),h=new g({content:c}));return h}})});